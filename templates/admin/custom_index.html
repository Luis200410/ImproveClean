{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
  :root {
    --card-bg: #ffffff;
    --card-border: rgba(15, 52, 96, 0.08);
    --accent-primary: #1d8cf8;
    --accent-dark: #0f1f3d;
  }

  .admin-analytics {
    padding: 2rem;
    background: linear-gradient(135deg, #f6f9ff 0%, #eef4ff 60%, #e0ebff 100%);
    border-radius: 26px;
    box-shadow: 0 24px 48px rgba(15, 52, 96, 0.18);
  }

  .analytics-grid {
    display: grid;
    gap: 1.5rem;
    grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
    margin-top: 1rem;
  }

  .analytics-card {
    background: var(--card-bg);
    border-radius: 20px;
    border: 1px solid var(--card-border);
    padding: 1.5rem;
    box-shadow: 0 20px 40px rgba(15, 52, 96, 0.12);
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .analytics-card h3 {
    margin: 0;
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #637089;
  }

  .analytics-card .metric {
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent-dark);
  }

  .status-grid, .service-grid {
    display: grid;
    gap: 0.75rem;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }

  .status-item, .service-item {
    background: #fff;
    border: 1px solid var(--card-border);
    border-radius: 18px;
    padding: 1rem;
    box-shadow: 0 16px 32px rgba(15, 52, 96, 0.1);
  }

  .progress-bar {
    background: rgba(29, 140, 248, 0.12);
    border-radius: 999px;
    height: 8px;
    overflow: hidden;
    margin-top: 0.5rem;
  }

  .progress-bar span {
    display: block;
    height: 100%;
    border-radius: inherit;
    background: linear-gradient(135deg, rgba(29, 140, 248, 0.8), rgba(51, 88, 244, 0.8));
  }

  .worker-rankings {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  }

  .worker-card {
    background: #fff;
    border: 1px solid var(--card-border);
    border-radius: 18px;
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .worker-card .avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, #e0e9ff, #f5f9ff);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: #2f3f52;
  }

  .upcoming-table {
    width: 100%;
    border-collapse: collapse;
  }

  .upcoming-table th,
  .upcoming-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid rgba(15, 52, 96, 0.08);
  }

  .upcoming-table tbody tr:hover {
    background: rgba(29, 140, 248, 0.06);
  }

  .app-list-wrapper {
    margin-top: 2rem;
  }

  .spark-list {
    display: grid;
    gap: 0.75rem;
  }

  .spark-item {
    background: #fff;
    border: 1px solid var(--card-border);
    border-radius: 16px;
    padding: 0.85rem 1rem;
    box-shadow: 0 14px 28px rgba(15, 52, 96, 0.08);
  }

  .spark-track {
    background: rgba(29, 140, 248, 0.12);
    border-radius: 999px;
    height: 6px;
    overflow: hidden;
    margin-top: 0.4rem;
  }

  .spark-fill {
    display: block;
    height: 100%;
    border-radius: inherit;
    background: linear-gradient(135deg, rgba(29, 140, 248, 0.8), rgba(51, 88, 244, 0.8));
  }

  .mini-table {
    width: 100%;
    border-collapse: collapse;
  }

  .mini-table th,
  .mini-table td {
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid rgba(15, 52, 96, 0.08);
  }

  .mini-table tbody tr:last-child td {
    border-bottom: none;
  }

  .schedule-list {
    list-style: none;
    padding: 0;
    margin: 0.75rem 0 0;
    display: grid;
    gap: 0.75rem;
  }

  .schedule-item {
    padding: 0.75rem 1rem;
    border-radius: 16px;
    border: 1px solid var(--card-border);
    background: #fdfdff;
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6), 0 12px 24px rgba(15, 52, 96, 0.08);
  }

  .schedule-item-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

.status-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 999px;
    font-size: 0.85rem;
    margin-right: 0.5rem;
    background: rgba(29, 140, 248, 0.12);
    color: #3358f4;
  }

  .status-icon.status-completed {
    background: rgba(40, 167, 69, 0.12);
    color: #28a745;
  }

  .status-icon.status-cancelled {
    background: rgba(220, 53, 69, 0.12);
    color: #dc3545;
  }

  .status-icon.status-pending {
    background: rgba(255, 193, 7, 0.18);
    color: #b8860b;
  }

  @media (max-width: 991px) {
    .admin-analytics {
      padding: 1.5rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="admin-analytics">
  <h1 class="display-6 mb-3">Concierge Analytics</h1>
  <p class="text-muted mb-4">Monitor bookings, rush demand, and staffing insights across the ImproveClean portfolio.</p>

  <div class="analytics-grid">
    <div class="analytics-card">
      <h3>Total bookings</h3>
      <span class="metric">{{ total_bookings }}</span>
      <span class="text-muted">All time</span>
    </div>
    <div class="analytics-card">
      <h3>Rush cleanings</h3>
      <span class="metric">{{ rush_total }}</span>
      <span class="text-muted">Auto-flagged requests</span>
    </div>
    <div class="analytics-card">
      <h3>New clients (30d)</h3>
      <span class="metric">{{ new_users }}</span>
      <span class="text-muted">Recently onboarded</span>
    </div>
    <div class="analytics-card">
      <h3>Upcoming week</h3>
      <span class="metric">{{ upcoming|length }}</span>
      <span class="text-muted">Scheduled next 7 days</span>
    </div>
    <div class="analytics-card">
      <h3>New bookings (7d)</h3>
      <span class="metric">{{ created_last_7 }}</span>
      <span class="text-muted">Created in the last 7 days</span>
    </div>
    <div class="analytics-card">
      <h3>New bookings (30d)</h3>
      <span class="metric">{{ created_last_30 }}</span>
      <span class="text-muted">Created in the last 30 days</span>
    </div>
    <div class="analytics-card">
      <h3>Completion rate (30d)</h3>
      <span class="metric">{{ recent_completion_rate }}<small>%</small></span>
      <span class="text-muted">{{ recent_completed }} completed</span>
    </div>
    <div class="analytics-card">
      <h3>Cancellation rate (30d)</h3>
      <span class="metric">{{ recent_cancellation_rate }}<small>%</small></span>
      <span class="text-muted">{{ recent_cancelled }} cancelled</span>
    </div>
  </div>

  <div class="mt-5">
    <h2 class="h5 mb-3">Operational health</h2>
    <div class="analytics-grid">
      <div class="analytics-card">
        <h3>Unassigned bookings</h3>
        <span class="metric">{{ unassigned_total }}</span>
        <span class="text-muted">{{ upcoming_unassigned }} in the next week</span>
      </div>
      <div class="analytics-card">
        <h3>Avg lead time</h3>
        <span class="metric">{{ avg_lead_days }}</span>
        <span class="text-muted">Days from creation to service</span>
      </div>
      <div class="analytics-card">
        <h3>Repeat clients</h3>
        <span class="metric">{{ repeat_rate }}<small>%</small></span>
        <span class="text-muted">{{ repeat_clients }} of {{ total_clients }} clients</span>
      </div>
      <div class="analytics-card">
        <h3>New client churn</h3>
        <span class="metric">{{ new_client_cancellation_rate }}<small>%</small></span>
        <span class="text-muted">{{ new_client_cancellations }} cancelled bookings (30d)</span>
      </div>
    </div>
  </div>

  <div class="mt-5">
    <h2 class="h5 mb-3">Booking status distribution</h2>
    <div class="status-grid">
      {% for item in status_summary %}
      <div class="status-item">
        <div class="d-flex justify-content-between align-items-center">
          <span class="fw-semibold">{{ item.label }}</span>
          <span class="badge bg-primary-subtle text-primary">{{ item.total }}</span>
        </div>
        <div class="progress-bar">
          <span style="width: {{ item.percent }}%"></span>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="mt-5">
    <h2 class="h5 mb-3">Service mix</h2>
    <div class="service-grid">
      {% for item in service_summary %}
      <div class="service-item">
        <div class="d-flex justify-content-between align-items-center">
          <span class="fw-semibold">{{ item.label }}</span>
          <span class="badge bg-info-subtle text-info">{{ item.total }}</span>
        </div>
        <small class="text-muted">{{ item.total }} bookings</small>
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="mt-5">
    <h2 class="h5 mb-3">Top professionals</h2>
    <div class="worker-rankings">
      {% for worker in worker_rankings %}
      <div class="worker-card">
        <div class="d-flex align-items-center gap-3">
          <span class="avatar">{{ worker.name|first }}</span>
          <div>
            <div class="fw-semibold">{{ worker.name }}</div>
            <div class="text-muted small">{{ worker.get_service_focus_display }} ¬∑ {{ worker.experience_years }} yrs</div>
          </div>
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <span class="text-muted small">Bookings assigned</span>
          <span class="badge bg-success-subtle text-success">{{ worker.booking_total }}</span>
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <span class="text-muted small">Upcoming week</span>
          <span class="badge bg-primary-subtle text-primary">{{ worker.upcoming_total }}</span>
        </div>
      </div>
      {% empty %}
      <p class="text-muted">No active workers yet. Add team members from the Workers admin.</p>
      {% endfor %}
    </div>
  </div>

  <div class="mt-5">
    <h2 class="h5 mb-3">Workforce utilization</h2>
    <div class="table-responsive">
      <table class="upcoming-table mini-table">
        <thead>
          <tr>
            <th>Professional</th>
            <th class="text-end">Upcoming (7d)</th>
            <th class="text-end">Lifetime bookings</th>
          </tr>
        </thead>
        <tbody>
          {% for worker in worker_utilization %}
          <tr>
            <td>{{ worker.name }}</td>
            <td class="text-end">{{ worker.upcoming_total }}</td>
            <td class="text-end">{{ worker.lifetime_total }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="3" class="text-center text-muted">No workers found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if idle_workers %}
    <p class="text-muted small mt-2">Idle next week: {% for worker in idle_workers %}{{ worker.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</p>
    {% endif %}
  </div>

  <div class="mt-5">
    <h2 class="h5 mb-3">Worker schedules (next 7 days)</h2>
    <div class="row g-3">
      {% for entry in worker_schedules %}
      <div class="col-xl-4 col-md-6">
        <div class="analytics-card h-100">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">{{ entry.worker.name }}</div>
              <div class="text-muted small">{{ entry.worker.get_service_focus_display|default:"Team member" }}</div>
              {% if entry.worker.phone_number or entry.worker.contact_email %}
              <div class="text-muted small">
                {% if entry.worker.phone_number %}<span class="me-2">üìû {{ entry.worker.phone_number }}</span>{% endif %}
                {% if entry.worker.contact_email %}‚úâÔ∏è {{ entry.worker.contact_email }}{% endif %}
              </div>
              {% endif %}
            </div>
            <span class="badge bg-primary-subtle text-primary">{{ entry.bookings|length }} jobs</span>
          </div>
          {% if entry.bookings %}
          <ul class="schedule-list">
            {% for booking in entry.bookings %}
            <li class="schedule-item">
              <a class="schedule-item-link" href="{% url 'worker_booking_detail' booking.pk %}?next={{ request.get_full_path|urlencode }}">
              <div class="d-flex justify-content-between align-items-start">
                <div class="d-flex">
                  {% if booking.worker_response == 'accepted' %}
                  <span class="status-icon status-completed">‚úì</span>
                  {% elif booking.worker_response == 'declined' or booking.status == 'cancelled' %}
                  <span class="status-icon status-cancelled">‚úï</span>
                  {% elif booking.worker_response == 'pending' %}
                  <span class="status-icon status-pending">?</span>
                  {% else %}
                  <span class="status-icon">‚úì</span>
                  {% endif %}
                  <div>
                    <div class="fw-semibold">{{ booking.scheduled_for|date:"M d, H:i" }}</div>
                    <div class="text-muted small">{{ booking.address }}</div>
                  </div>
                </div>
                <div class="text-end">
                  <span class="badge bg-light text-muted">{{ booking.get_service_type_display }}</span>
                  <div class="text-muted small">{{ booking.get_worker_response_display }}</div>
                  <div class="text-muted small">{{ booking.get_status_display }}</div>
                </div>
              </div>
              <div class="text-muted small mt-2">
                <strong>{{ booking.user.get_full_name|default:booking.user.username }}</strong>
                {% if booking.user.email %}
                ¬∑ <a href="mailto:{{ booking.user.email }}" class="text-decoration-none">{{ booking.user.email }}</a>
                {% endif %}
              </div>
              {% if booking.rush_cleaning %}
              <div class="text-warning small mt-1">Rush cleaning</div>
              {% endif %}
              </a>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="text-muted small mb-0">No assignments scheduled this week.</p>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="mt-5">
    <h2 class="h5 mb-3">Demand patterns (last 30 days)</h2>
    <div class="row g-3">
      <div class="col-lg-6">
        <div class="analytics-card">
          <h3>By weekday</h3>
          <div class="spark-list">
            {% for item in weekday_mix %}
            <div class="spark-item">
              <div class="d-flex justify-content-between">
                <span class="fw-semibold">{{ item.label }}</span>
                <span class="text-muted">{{ item.total }}</span>
              </div>
              <div class="spark-track">
                <span class="spark-fill" style="width: {% if weekday_peak %}{% widthratio item.total weekday_peak 100 %}{% else %}0{% endif %}%"></span>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="analytics-card">
          <h3>By hour</h3>
          <div class="spark-list">
            {% for item in hourly_mix %}
            <div class="spark-item">
              <div class="d-flex justify-content-between">
                <span class="fw-semibold">{{ item.label }}</span>
                <span class="text-muted">{{ item.total }}</span>
              </div>
              <div class="spark-track">
                <span class="spark-fill" style="width: {% if hourly_peak %}{% widthratio item.total hourly_peak 100 %}{% else %}0{% endif %}%"></span>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-5">
    <h2 class="h5 mb-3">Rush ratio trend</h2>
    <div class="table-responsive">
      <table class="upcoming-table mini-table">
        <thead>
          <tr>
            <th>Week starting</th>
            <th class="text-end">Bookings</th>
            <th class="text-end">Rush jobs</th>
            <th class="text-end">Rush ratio</th>
          </tr>
        </thead>
        <tbody>
          {% for row in rush_trend %}
          <tr>
            <td>{{ row.week|date:"M d" }}</td>
            <td class="text-end">{{ row.total }}</td>
            <td class="text-end">{{ row.rush }}</td>
            <td class="text-end">{{ row.ratio }}%</td>
          </tr>
          {% empty %}
          <tr><td colspan="4" class="text-center text-muted">No booking activity recorded.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="mt-5">
    <h2 class="h5 mb-3">Upcoming week</h2>
    <div class="table-responsive">
      <table class="upcoming-table">
        <thead>
          <tr>
            <th>When</th>
            <th>Client</th>
            <th>Service</th>
            <th>Professional</th>
            <th>Rush</th>
          </tr>
        </thead>
        <tbody>
          {% for booking in upcoming %}
          <tr>
            <td>{{ booking.scheduled_for|date:"M d, H:i" }}</td>
            <td>{{ booking.user.get_full_name|default:booking.user.username }}</td>
            <td>{{ booking.get_service_type_display }}</td>
            <td>{% if booking.worker %}{{ booking.worker.name }}{% else %}<span class="text-muted">Unassigned</span>{% endif %}</td>
            <td>{% if booking.rush_cleaning %}<span class="badge bg-warning text-dark">Rush</span>{% else %}<span class="badge bg-light text-muted">Standard</span>{% endif %}</td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="text-center text-muted">No upcoming bookings in the next week.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="mt-5">
    <h2 class="h5 mb-3">Admin reach (page views)</h2>
    <div class="analytics-grid">
      <div class="analytics-card">
        <h3>All time views</h3>
        <span class="metric">{{ page_view_total }}</span>
        <span class="text-muted">{{ unique_admins_30 }} unique admins (30d)</span>
      </div>
      <div class="analytics-card">
        <h3>30 day views</h3>
        <span class="metric">{{ page_view_30 }}</span>
        <span class="text-muted">{{ unique_sessions_30 }} unique sessions</span>
      </div>
      <div class="analytics-card">
        <h3>7 day views</h3>
        <span class="metric">{{ page_view_7 }}</span>
        <span class="text-muted">Last seen {{ last_page_view.viewed_at|date:"M d, H:i" }}</span>
      </div>
    </div>
  </div>
</div>

<div class="app-list-wrapper">
  {{ block.super }}
</div>
{% endblock %}

{% block sidebar %}{% endblock %}
